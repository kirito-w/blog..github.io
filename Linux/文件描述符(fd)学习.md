# 句柄（文件描述符）分配的过程及机制：

## 1、初始文件描述符
### 当一个程序启动时，通常会有以下三个标准文件描述符已经被分配：（`守护进程`比较特殊，会`释放0、1、2`供其他系统调用使用）
    - 标准输入（`stdin`）：文件描述符 `0`
    - 标准输出（`stdout`）：文件描述符 `1`
    - 标准错误（`stderr`）：文件描述符 `2`


## 2、分配新的文件描述符
### 发生以下的系统调用时，内核会搜索当前进程的`文件描述符表（FD Table）`，找到`第一个可用的最小整数`。
- open()
    - 调用 open() 系统调用打开一个文件时：
```
int fd = open("example.txt", O_RDONLY);
```
- socket()
    - 调用 socket() 时，也会分配一个新的文件描述符来表示创建的套接字。
```
int sockfd = socket(AF_INET, SOCK_STREAM, 0);
```

- pipe()
    - 调用 pipe() 创建管道，会分配一对文件描述符：一个用于读（read end），一个用于写（write end）。

## 3、释放文件描述符
```
close(fd);
```
- 通过`close(fd)显式关闭文件描述符`，释放它与内核资源的关联，`使该描述符可供再次分配`。
- `当进程终止`时，操作系统会`自动关闭所有由该进程打开的文件描述符`，并`释放相应的资源。`

## 4、并发环境中的分配
- 在`多线程或多进程环境`中，`文件描述符分配是线程安全的`，因为`内核内部有锁机制`，`确保文件描述符表的一致性`。

## 5、文件描述符的复用
- 由于`文件描述符是有限的`（通常是进程级别的整数，`默认限制为 1024 或更高`），当旧的文件描述符被关闭后，它们可以被重新分配
```
int fd1 = open("file1.txt", O_RDONLY);
close(fd1);
int fd2 = open("file2.txt", O_RDONLY);
// fd2 很可能会复用 fd1 的值。
```