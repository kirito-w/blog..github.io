## ARP协议：
----------------------------------------------------------------------
### 概念：
- ARP（Address Resolution Protocol）即地址解析协议，是用来将对方IP地址解析为MAC地址的一种协议。
- 用于实现从 IP 地址到 MAC 地址的映射。
- 在局域网通信中，当PC或其它网络设备有数据要发送给另一个主机或设备时，它必须知道对方的IP地址。但仅有IP地址是不够的，因为`IP数据报文必须封装成帧才能通过物理网络发送`，因此发送方PC还必须有接收方的物理地址（MAC地址）才可以，ARP就是实现将对方IP地址解析为MAC地址这个功能的协议。
- 主机发送信息时将包含目标IP地址的ARP请求**广播到局域网络上的所有主机**，并接收返回消息，以此确定目标的物理地址。
- 一般的ARP形式是向局域网络上的所有主机发送ARP请求包，其中包含主机 A 想要知道的主机 B 的 IP 地址的 MAC 地址。
- 简而言之，ARP 就是一种解决地址问题的协议，它以 IP 地址为线索，定位下一个应该接收数据分包的主机 MAC 地址。**如果目标主机不在同一个链路上，那么会查找下一跳路由器的 MAC 地址**。
- 如果是不同链路怎么办呢？这就要使用到 代理 ARP 了，通常 ARP 会被路由器隔离，但是采用代理 ARP (ARP Proxy) 的路由器可以将 ARP 请求转发给临近的网段。使多个网段中的节点像是在同一网段内通信。
----------------------------------------------------------------------
# 为什么必须要有arp？
- 在局域网中，当主机或其它三层网络设备有数据要发送给另一台主机或三层网络设备时，需要知道对方的网络层地址（即IP地址）。但是`仅有IP地址是不够`的，因为IP报文`必须封装成帧`才能通过物理网络发送，因此发送方`还需要`知道接收方的`物理地址（即MAC地址）`，这就需要一个通过IP地址获取物理地址的协议，以完成从IP地址到MAC地址的映射。址解析协议ARP即可实现将IP地址解析为MAC地址。

----------------------------------------------------------------------
### ARP 工作过程：
- 1、首先检查ARP缓存列表中是否有对应IP地址的目的主机的MAC地址源，如果有，直接发送数据；如果没有，设备`广播`ARP请求包，`该数据包包括的内容有：源主机IP地址，源主机MAC地址，目的主机的IP地址`。这个网络上的`所有设备`都会收到这个ARP请求;
- 2、如果一台设备发现请求中的IP地址与自己的`匹配`，首先会从数据包中`取出源主机的IP和MAC地址`写入到ARP缓存列表中，如果`已经存在，则覆盖`。然后向源设备发送一个`包含自己的MAC地址的ARP响应包`；如果`不匹配`，则将会`丢弃`这个ARP请求。
- 3、源主机收到ARP响应包后，将目的主机的IP和MAC地址`写入ARP缓存`列表，并利用此信息发送数据；如果源主机`一直没有收到ARP响应`数据包，表示`ARP查询失败`。

- ARP查询失败时常见故障排除:https://support.huawei.com/enterprise/zh/doc/EDOC1000079675/de4c5a9b

-----------------------------------------------------------------------
### ARP 缓存：
- ARP 高效运行的关键就是维护每个主机和路由器上的 ARP 缓存(或表)。
- 这个缓存维护着每个 IP 到 MAC 地址的映射关系。
- 通过把第一次 ARP 获取到的 MAC 地址作为 IP 对 MAC 的映射关系到一个 ARP 缓存表中，下一次再向这个地址发送数据报时就不再需要重新发送 ARP 请求了，而是直接使用这个缓存表中的 MAC 地址进行数据报的发送。
- 每发送一次 ARP 请求，缓存表中`对应的`映射关系都会被清除。
- 通过 ARP 缓存，降低了网络流量的使用，在一定程度上防止了 ARP 的大量广播。
----------------------------------------------------------------------
### ARP查看：
- windows查看ARP：
    - arp-a指令
- 路由器查看ARP：
    - arp-a指令
----------------------------------------------------------------------
### RARP：
- 与 ARP 相对的，RARP(Reverse Address Resolution Protocol) 是将 ARP 反过来，**从 MAC 地址定位 IP 地址的一种协议**，将打印机服务器等小型嵌入式设备接入网络时会使用到。
- 平常我们设置 IP 地址一般会有两种方式，手动设置 和 DHCP 动态获取，但是对于嵌入式设备来说，它**没有任何输入接口**，也**无法通过 DHCP 获取动态地址**, 在这种情况下，就要使用到 RARP 了。
- 你需要准备一个 RARP 服务器，在这个服务器上注册设备的 MAC 地址和 IP 地址，然后将设备接入网络，设备会发出一条 IP 和 MAC 地址的查询请求给服务器，服务器会告诉设备其 IP 地址和 MAC 地址。
----------------------------------------------------------------------
### ARP 攻击：
- ARP 是一种非常不安全的协议，目前已经有很多涉及 ARP 的攻击，最主要的就是使用**代理 ARP** 功能**假扮主机**，对 ARP 请求作出应答，通过伪造 ARP 数据包来窃取合法用户的通信数据，造成影响网络传输速率和盗取用户隐私信息等严重危害。
- ARP 攻击分类：
    - `ARP 泛洪攻击`：通过向网关发送大量 ARP 报文，导致网关无法正常响应。首先发送大量的 ARP 请求报文，然后又发送大量虚假的 ARP 响应报文，从而造成网关部分的 CPU 利用率上升难以响应正常服务请求，而且网关还会被错误的 ARP 缓存表充满导致无法更新维护正常 ARP 缓存表，消耗网络带宽资源。
    - `ARP 欺骗主机攻击`：ARP 欺骗主机的攻击也是 ARP 众多攻击类型中很常见的一种。攻击者通过 ARP 欺骗使得局域网内被攻击主机发送给网关的流量信息实际上都发送给攻击者。主机刷新自己的 ARP 使得在自己的ARP 缓存表中对应的 MAC 为攻击者的 MAC，这样一来其他用户要通过网关发送出去的数据流就会发往主机这里，这样就会造成用户的数据外泄。
    - `欺骗网关的攻击`: 欺骗网关就是把别的主机发送给网关的数据通过欺骗网关的形式使得这些数据通过网关发送给攻击者。这种攻击目标选择的不是个人主机而是局域网的网关，这样就会攻击者源源不断的获取局域网内其他用户韵数据．造成数据的泄露，同时用户电脑中病毒的概率也会提升。
    - `中间人攻击`: 中间人攻击是同时欺骗局域网内的主机和网关，局域网中用户的数据和网关的数据会发给同一个攻击者，这样，用户与网关的数据就会泄露。
    - `IP地址冲突攻击`: 通过对局域网中的物理主机进行扫描，扫描出局域网中的物理主机的 MAC 地址，然后根据物理主机的 MAC 进行攻击，导致局域网内的主机产生 IP 地址冲突，影响用户的网络正常使用。

----------------------------------------------------------------------

### ARP应用——检测IP地址冲突
- 何时？
    - 网络中新增设备时，例如添加新的路由器或者电脑。
- 在给`主机分配IP地址或更改了IP地址后`，主机可以`以自己的IP地址作为目的IP地址，进行ARP Request广播`。如果`该网段下有重复的IP`地址，则会`接收到ARP reply报文`，并且可以知道`哪个网卡与此IP重复`了，从而可以`避免IP的复用`。
- 指令：arping IP——当同一个ip返回是同一个mac地址时，没有冲突；如果`同时返回多个mac地址时，表示地址冲突`。
    - arping 命令安装: apt-get install iputils-arping

----------------------------------------------------------------------
### 总结：
- ARP 是 TCP/IP 实现中的一个基本协议，它通常在应用程序或用户没有察觉到的情况下运行。ARP 可以用于映射 IP 地址为 MAC 地址。

