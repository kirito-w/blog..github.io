## ping包在传递过程中，是`一跳一跳转发`的，每经过一个`交换机`，`不停留不拆包`直接`按目的mac转发`，`每经过一个路由器拆封包一次`。`更换二层包头`，去掉上一网段Mac地址，`换成下一网段Mac地址`。在ping包的整个传输过程中，`源IP和目的IP始终不变`。

## ping外网的过程  
![](img/%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20240816183147.png)
### 外网ping过程：（此例为：pc1--ping--pc3----------192.168.1.1--ping --172.16.1.1）
- 1.ping开始
- 2.ICMP协议检查目标`IP不在同一网段`，`直接发包给网关`
- 3.封包时，`有网关Mac直接封包`，如果没有网关Mac，则arp网关IP，请求网关mac，此例为arp 192.168.1.254
- 4.完成封包，发包给网关（目的Mac：路由器1接口1Mac--源Mac：pc1网卡mac--目的IP：172.16.1.1--源IP：192.168.1.1）
- 5.路由器1接口1收到包后，检查`包头目的Mac和自己接口1Mac`, `一致拆包，不一致丢弃`。
- 6.检查`Mac一致`后，`拆开二层包头后丢弃包头`，转交给包头中标注的上层协议IP协议处理，IP协议检查三层包头，`根据目的IP找路由表对应下一跳接口`，此处路由表中有172.16.1.0网络条目（每个途径的路由器的路由条目都应该有目的IP的路由，否则会因为路由不可达而ping不通，路由条目一般由路由协议动态获得，如网络简单也可手工静态建立,现实网络中在路由协议建立邻居的时候其实已经获得邻居的mac地址，完成了地址表的建立，ping包会自动在网络中畅通传输，不需要每一步都arp，只有在首尾两端客户机上才偶尔会用到arp）
- 8.如果路由表中没有目的IP对应的出口，则丢弃包，并返回给源IP一个relay报文，告知对方报文不可达。
- 9.路由器1找到下一跳后重新封包，（目的Mac:路由器2接口1Mac--源Mac：路由器1接口2Mac-目的IP：172.16.1.1--源IP：192.168.1.1）
- 10.如果mac地址表（路由器也有此表）中没有下一跳接口地址对应的mac，ARP查询获取后封包。
- 11.路由器2从接口1收到包后，核对目的Mac和接口1的mac一致，拆包，丢包头，根据包头协议号，把包转给上层协议IP协议处理。
- 12.IP协议检查目的IP，找路由表对应条目（此条目包含下一跳IP或根据出接口能递归查询到下一跳IP地址）发送出去，发送前封包（目的Mac:路由器3接口1Mac--源Mac：路由器2接口2Mac-目的IP：172.16.1.1--源IP：192.168.1.1）
- 13.路由器3接口1收到包，查包目的Mac和接受接口1mac，不一致，拆包，一致，拆包，丢掉二层包头，交给上层协议IP处理，IP根据目的IP，找到出口，arp获得或查表得下一跳Mac，封装，发给下一跳。（目的Mac:pc2网卡Mac--源Mac：路由器3接口2Mac-目的IP：172.16.1.1--源IP：192.168.1.1）
- 14.pc2网卡收到包后，查mac一致，拆包，丢包头，转给上层协议（IP协议）处理，IP检查目的IP和自己IP一致，拆包，丢包头，根据包头指定协议号把包转给上层协议ICMP，ICMP根据协议规则查看type=0code=0是个echo-relay报文，立即给源地址发送echo-relay报文。
- 15.pc1接受到echo-relay报文得知网路畅通。ping一次完整过程完成。


https://blog.csdn.net/wyunller/article/details/89464611
