# 写博客学习一下
# 连接跟踪
## 什么是连接跟踪？
- 连接跟踪是Linux内核中引入的`nf_conntrack` 模块所实现的功能，同时支持IPv4 和 IPv6，取代只支持 IPv4 的 ip_connktrack，用于跟踪连接的状态，供其他模块使用。
- 顾名思义，就是`跟踪并且记录连接状态`。Linux`为每一个经过网络堆栈的数据包`都会`记录其状态`，生成一个`新的连接记录`，并将`后续的数据包`都分配给`对应的连接`，并`更新连接的状态`。
- 连接跟踪`主要用于`Linux的`NAT`以及`状态防火墙`。

## 认识连接跟踪
- 通常情况下，连接跟踪模块会为每一个连接记录多个信息，用以区分不同的连接。多条连接记录组成一个连接跟踪表。
- 首先查看一条连接跟踪记录，通常使用下面两种命令（不同系统可能有所区别）
    - conntrack -L
    - cat /proc/net/nf_conntrack

## 连接跟踪的工作原理
- 如上所见，连接跟踪通过记录多种数据包的信息来确定每个数据包应该匹配到哪一个连接，通常我们把这些信息叫做连接跟踪的`五元组(目的ip地址、目的端口、源ip地址、源端口、协议号)`，当然针对不同的协议，可能还有四元组、七元组等等，也存在为了特殊需要而修改连接跟踪模块使其记录更多信息情况。


## 连接跟踪的具体实现
### 首先要说明的是Linux内核中对于网络数据包处理的netfilter框架，该部分内容在后面状态防火墙也会提到。
### 对于数据包的处理，`netfilter有五个链（chain）`，分别`表示数据包在处理的五个不同过程`：
- PRE_ROUTING：数据包进入路由表之前
- LOCAL_IN：通过路由表后目的地为本机
- FORWARD：通过路由表后目的地不为本机
- LOCAL_OUT：由本机产生向外转发
- POST_ROUTING：发送到网卡接口之前。

### Linux的`防火墙iptables有四个表（table）`，分别记录`不同过程中对于数据包的处理方式`：
- filter：一般的过滤功能，默认使用该表
- nat：用于nat功能（端口映射，地址映射等）
- mangle： 用于对特定数据包的修改
- raw：优先级最高，设置raw时一般是为了不再让iptables做数据包的链接跟踪处理，提高性能

### 表和链的关系（数据包的处理流程）：  
![](img/%E8%A1%A8%E5%92%8C%E9%93%BE%E7%9A%84%E5%85%B3%E7%B3%BB.png)

### 实际上PRE_ROUTING和LOCAL_IN可以看作是整个`收包流程`的入口和出口，而LOCAL_OUT和POST_ROUTING可以看作是`出包流程`的入口和出口。在只考虑连接跟踪的情况下，一个数据包无外乎有以下三种流程可以走：
- `发送给本机`的数据包:
    - PRE_ROUTING --> LOCAL_IN --> 本地进程
- `需要本机转发`的数据包：
    - PRE_ROUTING --> FORWARD --> POST_ROUTING --> 外出
- `从本机发出`的数据包：
    - LOCAL_OUT --> POST_ROUTING --> 外出

## 常见问题
- 连接跟踪记录数量限制: 连接跟踪表满是经常会遇到的问题，连接跟踪记录最大值是系统默认设置的，可以通过使用下述命令查看与设置
```
cat /proc/sys/net/netfilter/nf_conntrack_max
sysctl -p
```
- 如何统计连接跟踪: 可以通过`查看文件直接获取当前的连接跟踪记录数`，也可以通过查看全部记录后grep出`ESTABLISHED`的连接来统计出`当前已经建立的记录数`
```
cat /proc/sys/net/netfilter/nf_conntrack_count
```

=========================================================================

# NAT
## 借助于连接跟踪模块，netfilter实现了NAT（Network Address Translation）功能，也就是网络地址转换。NAT主要包含两种：SNAT（源地址转换）和DNAT（目的地址转换）
- `SNAT`：SNAT是修改数据包的源地址和端口，主要用于内网访问互联网的情况，将内网IP地址转换为公网IP地址。在iptables规则中，源地址转换分为SNAT和MASQUERADE两种，SNAT即为静态源地址转换，将制定的网段一对一的转换为设定的目标网段，而MASQUERADE是将指定的网段转换为从出口网卡上获取到的IP网段地址，实现一种动态地址转换
- `DNAT`：DNAT是修改数据包中的目的地址和端口，通常用于内网开放服务给互联网访问的情况，例如端口映射。将设备公网接口上唯一的公网IP对应的转换到内网服务的内网IP
## 在防火墙`将数据包的地址转换修改`后，必须`要记录数据包的修改转换过程`，否则对应连接的包再到达时就`无法知道将数据包发送给谁`了，因此这就是NAT功能利用连接跟踪的地方，通过`基于数据包状态建立的连接跟踪表`，就能`找到对应数据包所属的链接`，从而`维护NAT的状态`。

------------------------------  

## 源地址转换的主要步骤大致如下：
- 1、数据包进入Hook（例如ip_nat_out）函数后，进行规则匹配
- 2、如果所有match都匹备，则进行SNAT模块的动作，即snat的target模块
- 3、源地址转换的规则一般是…… -j SNAT –to X.X.X.X，SNAT用规则中预设的`转换后地址X.X.X.X`，修`改连接跟踪表中的replay tuple`（原因：当数据包进入连接跟踪后，会建立一个tuple以及相应的replay tuple，而应答的数据包，会查找与之匹配的repaly tuple，——对于源地址转换而言，应答包中的目的地址，将是转换后的地址，而不是真实的地址，所以，为了让应答的数据包能找到对应的replay tuple，很自然地，NAT模块应该修改replaly tuple中的目的地址，以使应答数据包能找到属于自己的replay）
- 4、接着，`修改数据包的来源的地址`，将它`替换成replay tuple中的相应地址`，即规则中预设的地址，将其发送出去
- 5、对于回来的数据包，应该能在状态跟踪表中，查找与之对应的replay tuple，也就能顺藤摸瓜地找到原始的tuple中的信息，将应答包中的目的地址改回来，这样，整个数据传送就得以顺利转发了
## 例如主机ip为192.168.18.2，网关ip为192.168.20.1，欲访问202.10.10.1，使用协议为TCP。
- 1、LOCAL_OUT后，刚开始会生成两个连接跟踪 —— 192.168.18.2:120 --> 202.10.10.1:30 TCP(ORIGINAL) 和 202.10.10.1:30 --> 192.168.18.2:120 TCP(REPLAY)
- 2、在POST_ROUTING后，连接跟踪会变为 —— 192.168.18.2:120 --> 202.10.10.1:30 TCP(ORIGINAL) 和 202.10.10.1:30 --> 192.168.20.1:450 TCP(REPLAY)
- 3、对于从202.10.10.1:30回来的数据包：
    - 首先发现存在 202.10.10.1:30 --> 192.168.20.1:450 TCP(REPLAY) —— 即`先前有SNAT`，需要找对应的ORIGINAL连接跟踪。
    - 然后找到192.168.18.2:120 --> 202.10.10.1:30 TCP(ORIGINAL)知道来自202.10.10.1:30的TCP报文都应该回给192.168.18.2:120

=========================================================================

# 状态防火墙
## iptables是Linux中netfilter框架的防火墙配置模块，通过iptables我们可以设定netfilter采用何种规则来处理数据包。而通过使用nf_conntrack模块，防火墙可以加入对于数据包状态的处理。
## 通常我们会在iptables的配置中看到类似于下面这种，`带有-m参数且指定了状态`，这就是`采用了状态防火墙`的拓展，`筛选出匹配状态的数据包`进行下一步处理
```
iptables -A OUTPUT 1 -m state --state ESTABLISHED -j ACCEPT
```
## 在状态防火墙中，一共有四种状态：
- NEW — 请求新连接的分组，如 HTTP 请求、TCP的握手等。
- ESTABLISHED — 开始正常传输数据，属于当前连接的一部分的分组，叫做已经建立的连接分组。
- RELATED — 请求新连接的分组，但是它也是当前连接的一部分，如消极 FTP 连接，其连接端口是 20，但是其传输端口却是 1024 以上的未使用端口。
- INVALID — 不属于连接跟踪表内任何连接的分组，无法识别的数据包。
### 通过使用状态防火墙，我们可以实现很多功能，比如只针对已经建立连接的数据包进行转发，或者对无效数据包进行丢弃以防止内网NAT泄露等等

=======================================

# 相关文档：
- http://www.linvon.cn/posts/%E8%BF%9E%E6%8E%A5%E8%B7%9F%E8%B8%AAnf_conntrack%E4%B8%8Enat%E5%92%8C%E7%8A%B6%E6%80%81iptables/
- https://www.cnblogs.com/liushaodong/archive/2013/02/26/2933593.html
- http://blog.chinaunix.net/uid-23069658-id-3169450.html